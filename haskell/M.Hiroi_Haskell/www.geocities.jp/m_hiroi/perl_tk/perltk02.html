<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>お気楽 Perl/Tk プログラミング入門</title>
  <meta name="description" content="Perl/Tk,Perl/Tk入門,GUI,プログラミング">
  <link rel="stylesheet" type="text/css" href="../home_styles.css">
</head>
<body><!-- geoguide start --><div align=center><script language="javascript">var jps=382116062;var jpt=1550881764</script><script language="javascript" src="http://bc-geocities.yahoo.co.jp/js/gg.js"></script></div><!-- geoguide end -->
M.Hiroi's Home Page
<div class="small">
http://www.geocities.jp/m_hiroi/
</div>
<div class="ce">
<h1>Perl/Tk memo</h1>
<h2>お気楽 Perl/Tk プログラミング入門</h2>
<div class="small">
[ <a href="perltk01.html">PrevPage</a> | <a href="index.html">Perl/Tk</a> | <a href="perltk03.html">NextPage</a> ]
<hr>
</div>
</div>
<section class="contents">
<h3 id="chapter4">フォントの指定</h3>
<h4>●フォントの形式</h4>
<p> 今度は色だけではなくフォントも変更してみましょう。フォントの指定には、いくつかの方法があるのですが、Windows 上ならば次の形式で行えばいいでしょう。
</p>
<pre class="item">
無名の配列： [family, size, style1, style2]
文字列： 'family size style1 style2'
</pre>
<p> フォントは無名の配列、または文字列を使って指定することができます。文字列で指定する場合は、要素を空白で区切ります。family はフォント名を表します。いまあなたが使っているパソコンで使用できるフォント名は、メソッド fontFamilies で求めることができます。Windows であれば 'ＭＳ 明朝' や 'ＭＳ ゴシック' といった名前を見つけることができるでしょう。size はフォントの大きさを表し数値で指定します。style1 と style2 はフォントのスタイルで、次の中から選びます。
</p>
<pre class="item">
style1 : normal, bold, roman, italic
style2 : underline, overstrike
</pre>
<p> style1 と style2 は省略することができます。それでは、フォントを変更してみましょう。次のプログラムを見てください。
</p>

<pre class="list">
リスト : フォントの変更

use Tk;

$top = MainWindow-&gt;new();

$top-&gt;Label(-text =&gt; 'Hello, world',
            -font =&gt; ["ＭＳ ゴシック", 12] )-&gt;pack();

$top-&gt;Label(-text =&gt; 'Hello, world',
            -font =&gt; ["ＭＳ 明朝", 12,italic] )-&gt;pack();

$top-&gt;Label(-text =&gt; 'Hello, world',
            -font =&gt; ["ＭＳ ゴシック", 16, underline] )-&gt;pack();

MainLoop();
</pre>
<p> テキストを表示するウィジェットは、オプション -font で使用するフォントを指定することができます。それでは実行してみましょう。
</p>

<img src="img/font1.png" alt="フォントの画面"> フォントをいろいろ変えてみる

<h4>●オプションの設定</h4>
<p> このように、個々のウィジェットのフォントはオプション -font で変更できますが、すべてのラベルウィジェットで使用する共通のフォントを設定したい場合もあるでしょう。Tk は各オプションのデフォルト値を持っています。このため、ユーザーは必要なオプションを指定するだけで、簡単にプログラミングすることができます。このデフォルト値はメソッド optionAdd を使って変更することができます。
</p>
<p> たとえば、アプリケーションで使用するフォントを変更する場合は、次のように行います。
</p>
<pre class="item">
$top-&gt;optionAdd( '*font' =&gt; 'FixedSys 14' );
</pre>
<p> $top はメインウィンドウを表します。これで、テキストを表示するウィジェットは、指定したフォントを使って表示されます。第 1 引数は、値を設定するウィジェットを表すパターンです。第 2 引数は省略していますが、優先順位 priority (0 - 100) を設定することができます。
</p>
<p> パターンは、アプリケーション名、ウィジェット名、オプション名をドットで区切って表しますが、ワイルドカード * やウィジェットを表すクラス名を指定することもできます。*font の場合は、アプリケーションで使用するフォントを指定することになります。ラベルに対してフォントを設定したい場合は *Label.font となります。
</p>
<div class="note">
-- <b>[修正 (2001/01/16)]</b> --------<br>
以前のドキュメント(1月10日)では、optionAdd の font の指定で無名の配列を使ったため、フォントが正しく設定されていませんでした。詳しくは <a href="perltk02.html#update">追記</a> をご覧くださいませ。
</div>
<p>  たとえば、前回作成したボタンを表示するプログラムに次の 2 行を加えてください。
</p>
<pre class="list">
$top-&gt;optionAdd( '*Button.font' =&gt; 'FixedSys 14' );
$top-&gt;optionAdd( '*Button.background' =&gt; green );
</pre>
<p> これで、表示されるボタンのフォントと背景色は、設定された値となります。
</p>
<img src="img/font2.png" alt="フォントの画面"> ボタンのフォントと背景色を変更

<h4 id="update">●追記 (2001/1/16)</h4>
<p> ところで、M.Hiroi が使用している Tk.pm (version 800.022) では、optionAdd でフォントを指定する場合、無名の配列を使うと正常に動作しません。フォントの指定には文字列を使ってください。ただし、要素を空白で区切るため、'ＭＳ ゴシック' のように空白を含むフォント名を指定すると、ＭＳをフォント名と判断するためエラーになってしまいます。この場合、メソッド fontCreate を使って、アプリケーション独自のフォント名を作成してください。
</p>
<pre class="item">
$widget-&gt;fontCreate( fontname, option =&gt; value, ... );
</pre>
<p> 第 1 引数には作成するフォント名、あとの引数にはオプションを設定します。オプションはフォントの指定とほとんど同じです。
</p>

<table border=1>
<caption>表：fontCreate の主なオプション</caption>
<tbody>
  <tr><td>-family</td><td>フォント名</td></tr>
  <tr><td>-size</td><td>サイズ</td></tr>
  <tr><td>-weight</td><td>normal, bold</td></tr>
  <tr><td>-slant</td><td>roman, italic</td></tr>
  <tr><td>-underline</td><td>下線の指定(boolean)</td></tr>
  <tr><td>-overstrike</td><td>打ち消し線の指定(boolean)</td></tr>
</tbody>
</table>

<p> プログラムは次のようになります。
</p>
<pre class="list">
# フォントの設定
$top-&gt;fontCreate('MS', -family =&gt; 'ＭＳ ゴシック' );
# オプションの指定
$top-&gt;optionAdd( '*Button.font' =&gt; 'MS 12' );
</pre>
<p> fontCreate で MS というフォント名を作成します。ここで -family に 'ＭＳ ゴシック' を設定します。あとは、optionAdd でフォントに MS を指定すれば、ボタンのフォントを 'ＭＳ ゴシック' にすることができます。
</p>
</section>
<hr>
<section class="contents">
<h3 id="chapter5">メニューバー</h3>
<p> 次は GUI には欠かせないメニューの作り方を説明します。Tk ではメニューのためのウィジェットがいくつか用意されていて、いろいろなメニューを構成することができます。今回は、Windows でも標準になっている <b>メニューバー</b> という方法を説明します。
</p>
<h4>●メソッド Menu</h4>
<p> メニューを作るにはメソッド Menu を使います。メニューバーの場合はオプション -type で menubar を指定します。作成したメニューバーはメインウィンドウのオプション -menu で配置します。プログラムは次のようになります。
</p>

<pre class="list">
リスト : メニューバーの設定

$top = MainWindow-&gt;new();
$m = $top-&gt;Menu( -type =&gt; 'menubar' );
$top-&gt;configure( -menu =&gt; $m );
</pre>

<p> これでメインウィンドウにメニューバーが設定されました。あとはこのメニューバーに具体的なメニューを追加します。メニューを設定する主なメソッドを示します。
</p>
<ul>
  <li><b>cascade</b><br>     複数のメニューを表示する
  <li><b>checkbutton</b><br> チェックボタンを表示
  <li><b>command</b><br>     -command で指定したコマンドを実行
  <li><b>radiobutton</b><br> ラジオボタンを表示
  <li><b>separator</b><br>   区切りを表示する
</ul>
<p> 各メソッドはオプションを設定することができます。cascade を指定すると、そのメニューを選択したときに複数のメニューを表示します。checkbutton は yes/no のような二者択一の情報を設定するために使います。command はメニューが選択されたときに、オプション -command で指定したコマンドを実行します。radiobutton は複数の値からひとつを選ぶ場合に使います。separator は区切りを表示するだけです。
</p>

<p> checkbutton と radiobutton はメニューバーに直接定義するのではなく、cascade と組み合わせて使うことが一般的です。checkbutton と radiobutton を使う場合、選択する値をオプション -value で指定し、その値を格納する変数をオプション -variable で指定します。また、-command オプションを設定することもできます。この場合、変数に値がセットされるとともに、指定したコマンドが実行されます。
</p>

<h4>●簡単な例題</h4>
<p> たとえば、将棋やリバーシのようなゲームのメニューを考えてみましょう。最低限必要となるメニューは、ゲームの開始、先手と後手の選択、コンピュータの強さの設定、などでしょうか。最初の 2 つはメニュー Games で設定し、強さはメニュー Level で選択することにします。この場合、まず Games と Level をメニューバーに追加します。
</p>

<pre class="list">
リスト : cascade の設定

$m1 = $m-&gt;cascade(-label =&gt; 'Games', -under =&gt; 0, -tearoff =&gt; 0);
$m2 = $m-&gt;cascade(-label =&gt; 'Level', -under =&gt; 0, -tearoff =&gt; 0);
</pre>
<p> オプション -label はメニューに表示するテキストを設定します。オプション -underline は、ラベルの文字に下線を付け加えます。Windows の場合、Alt キーでメニューを選択できますが、この状態で下線のついた文字をキーボードから入力することで、そのメニューを選ぶことができます。
</p>
<p> オプション -tearoff は、そのメニューをウィンドウから引きちぎることができるかを設定します。デフォルトでは yes になっています。その場合、メニューを選択すると一番上に破線が表示され、そこをクリックするとそのメニューが独立したウィンドウになります。
</p>
<p> cascade は Menu のインスタンス (具体的には Tk::Menu::Cascade のインスタンス) を返すので、そこにメニューの項目を追加します。それではメニュー Games を設定しましょう。
</p>

<pre class="list">
リスト : Games の設定

$m1-&gt;command(-label =&gt; 'Start', -under =&gt; 0, -command =&gt; \&amp;start );
$m1-&gt;separator;
$m1-&gt;radiobutton(-label =&gt; 'first', -variable =&gt; \$action, -value =&gt; 0);
$m1-&gt;radiobutton(-label =&gt; 'second', -variable =&gt; \$action, -value =&gt; 1);
$m1-&gt;separator;
$m1-&gt;command(-label =&gt; 'exit', -under =&gt; 0, -command =&gt; \&amp;exit );
</pre>

<p> Start を選ぶとゲームを開始します。ゲームを開始するコマンド、これはゲームによって異なりますが、この例では start を実行します。
</p>
<p> 先手・後手の選択はラジオボタンを使っています。これで、先手、後手のどちらかを選ぶことができます。たとえば、後手をクリックすると、action の値は 1 にセットされ、ラベルの左側にレ点がつきます。使用する変数は、あらかじめ初期化しておきましょう。
</p>
<p> これで Games をクリックすると、Start、先手・後手、Exit という 3 つのメニューが現れます。
</p>

<img src="img/menu0.png" alt="メニュー GAMES の画像"> Games をクリックしたときの動作

<p> 次はメニュー Level の設定です。
</p>

<pre class="list">
リスト : メニューの設定 (4)

$m2-&gt;radiobutton(-label =&gt; 'Level 1', -variable =&gt; \$level, -value =&gt; 1);
$m2-&gt;radiobutton(-label =&gt; 'Level 2', -variable =&gt; \$level, -value =&gt; 2);
$m2-&gt;radiobutton(-label =&gt; 'Level 3', -variable =&gt; \$level, -value =&gt; 3);
</pre>

<p> ラジオボタンを使えば 3 つの中からひとつを選ぶことができます。ゲームの中身は空ですが、このように簡単にメニューを設定することができます。
</p>

<img src="img/menu1.png" ALT="メニュー Level の画像"> Level をクリックしたときの動作

<h4>●プログラムリスト</h4>
<pre class="list">
リスト : メニューのサンプルプログラム

use Tk;

# グローバル変数
$level = 1;
$action = 0;

# ダミー
sub start { }

# メインウィンドウ
$top = MainWindow-&gt;new();

$top-&gt;optionAdd( '*font' =&gt; 'FixedSys 14' );
$m = $top-&gt;Menu( -type =&gt; 'menubar' );
$top-&gt;configure( -menu =&gt; $m );

# cascade の設定
$m1 = $m-&gt;cascade(-label =&gt; 'Games', -under =&gt; 0, -tearoff =&gt; 0);
$m2 = $m-&gt;cascade(-label =&gt; 'Level', -under =&gt; 0, -tearoff =&gt; 0);

# Games の設定
$m1-&gt;command(-label =&gt; 'Start', -under =&gt; 0, -command =&gt; \&amp;start );
$m1-&gt;separator;
$m1-&gt;radiobutton(-label =&gt; 'first', -variable =&gt; \$action, -value =&gt; 0);
$m1-&gt;radiobutton(-label =&gt; 'second', -variable =&gt; \$action, -value =&gt; 1);
$m1-&gt;separator;
$m1-&gt;command(-label =&gt; 'exit', -under =&gt; 0, -command =&gt; \&amp;exit );

# Level の設定
$m2-&gt;radiobutton(-label =&gt; 'Level 1', -variable =&gt; \$level, -value =&gt; 1);
$m2-&gt;radiobutton(-label =&gt; 'Level 2', -variable =&gt; \$level, -value =&gt; 2);
$m2-&gt;radiobutton(-label =&gt; 'Level 3', -variable =&gt; \$level, -value =&gt; 3);

# Label ウィジェットの設定
$l = $top-&gt;Label( -text =&gt; '***** Menu Test *****' );
$l-&gt;pack();

MainLoop();
</pre>
</section>
<hr>
<section class="contents">
<h3 id="chapter6">キー入力とバインド</h3>
<p> 今までの例題は、マウスで操作するものばかりでした。今度はキーボードからの入力を受け付けるウィジェットを説明します。
</p>
<h4>●エントリー</h4>
<p> エントリー (entry) は 1 行の文字列を入力、または編集することができます。例題として、数式を入力して計算する calc.pl を作ります。これはとても簡単に作ることができます。まずエントリーから説明しましょう。
</p>
<p> エントリーはメソッド Entry で作成します。よく使うオプションは -textvariable です。エントリーで入力されたデータは指定したグローバル変数に格納されます。また、グローバル変数の値が変更されると、エントリーの内容も変更されます。面白いオプションが -show です。これはパスワードのように画面に見えてはいけない文字列を打ち込むときに使います。たとえば、-show =&gt; '*' とすれば、入力された文字は * として表示されます。
</p>
<p> メソッドは cget, configure のほかに、文字列の取得、挿入、削除、カーソルの移動、カット &amp; ペースト、スクロールなど、たくさん用意されていますが、文字列の入力だけならば、それらを使う機会はあまりないでしょう。また、エントリーのキー操作は Emacs に準じているので、Emacs / Mule を使っているユーザーには扱いやすいと思います。
</p>
<h4>●式入力電卓の制作</h4>
<p> それではプログラムを作りましょう。データの入力が完了したらボタンを押してもらってもいいのですが、データはキーボードから入力するのですから、マウスよりもキーボードで操作した方がいいでしょう。リターンキーの入力でデータを計算するようにします。キー入力もイベントのひとつですからバインディングを設定することができます。プログラムは次のようになります。
</p>

<pre class="list">
リスト : 式入力電卓

use Safe;
use Tk;

$buffer = "";
$cpt = new Safe;

# 計算
sub calc {
    $buffer = $cpt-&gt;reval( $buffer );
}

$top = MainWindow-&gt;new();
$e0 = $top-&gt;Entry( -textvariable =&gt; \$buffer );
$e0-&gt;pack();
$e0-&gt;focus;
$e0-&gt;bind("&lt;Return&gt;", \&amp;calc );  # バインディング

MainLoop();
</pre>

<p> 計算は関数 eval を使えば簡単です。eval は与えられた文字列を Perl のコードとして実行します。eval を使う場合、system などの危険な関数は、実行できないようにしておいた方が安全です。このため、Safe モジュールを使うことにします。メソッド reval が文字列を Perl のコードとして評価しますが、危険な関数は実行できません。
</p>
<p> とても簡単なプログラムですが、sin, cos, tan など Perl に定義されている関数を呼び出すことができるので、簡単な関数電卓としても使うことができます。
</p>

<img src="img/entry0.png" alt="電卓入力の画面"> 数式を入力する
<br><br>
<img src="img/entry1.png" alt="計算結果の画面"> リターンキーで計算する

<h4>●イベント処理</h4>
<p>このプログラムのポイントは bind メソッドです。
</p>
<pre class="item">
$widget-&gt;bind( eventsequence, callback );
</pre>
<p> すでにバインドされているコールバック関数がある場合、新しい関数に差し替えられます。callback を省略すると、そのイベントにバインドされている関数が返されます。引数を省略すると、そのウィジェットにバインドされているすべてのイベントを、リストに格納して返します。
</p>
<p> それから、bind で設定されたコールバック関数が呼び出される場合、第 1 引数にウィジェットのインスタンスがセットされ、そのあとに指定した引数がセットされます。ご注意くださいませ。
</p>
<p> イベントの指定は次のような構文を持っています。
</p>
<pre class="item">
&lt;modifier-modifier-type-detail&gt;
</pre>
<p> type は GUI 環境上で発生するイベントタイプを表します。ユーザーが操作するときに発生する主なイベントタイプには次のようなものがあります。
</p>
<table border=1>
<caption>表：イベントタイプ</caption>
<tbody>
  <tr><td>Key, KeyPress</td><td>キーが押された</td></tr>
  <tr><td>KeyRelease</td><td>キーが離された</td></tr>
  <tr><td>Button, ButtonPress</td><td>マウスのボタンが押された</td></tr>
  <tr><td>ButtonRelease</td><td>マウスのボタンが離された</td></tr>
  <tr><td>Motion</td><td>マウスの移動</td></tr>
  <tr><td>Enter</td><td>マウスカーソルがウィンドウの中に入った</td></tr>
  <tr><td>Leave</td><td>マウスカーソルがウィンドウから出た</td></tr>
</tbody>
</table>
<p> このほかにも、ウィンドウが破棄されたときに発生するイベントなど、様々なイベントタイプがあります。
</p>
<p> マウスとキーのイベントには、ボタンやキーの種類を detail で指定します。マウスでは左ボタンが 1 となります。キーの種類は名前で指定します。英数字はその文字がそのまま名前となります。このほかに、改行キーに対する Return、バックスペースキーに対する BackSpace などがあります。
</p>
<p> detail を指定する場合は type を省略することができます。ただし、&lt;1&gt; という指定は &lt;KeyPress-1&gt; ではなく &lt;Button-1&gt; となるので注意してください。また、通常の英数字の場合、&lt;&gt; も省略することができます。つまり、&lt;KeyPress-a&gt; は a と書くことができます。それから、&lt;KeyPress&gt; のように detail を省略すると、種類によらずキーが押されたときにバインドされたコマンドが実行されます。
</p>

<h4>●モディファイア</h4>
<p> イベントタイプの前にはモディファイア (modifier) をつけることができます。たとえば、&lt;Control-d&gt; はコントロールキーと d キーを同時に押したときのイベントを表します。主なモディファイアを次に示します。
</p>

<table border=1>
<caption>表：モデファイア</caption>
<tbody>
  <tr><td>Control</td><td>Ctrl キーを押しながらの入力</td></tr>
  <tr><td>Shift</td><td>Shift キーを押しながらの入力</td></tr>
  <tr><td>Alt</td><td>Alt キーを押しながらの入力</td></tr>
  <tr><td>Button1, B1</td><td>マウスの左ボタンを押しながらの入力</td></tr>
  <tr><td>Button3, B3</td><td>マウスの右ボタンを押しながらの入力</td></tr>
  <tr><td>Double</td><td>ダブルクリック</td></tr>
  <tr><td>Triple</td><td>トリプルクリック</td></tr>
</tbody>
</table>

<p> Tk の出身地である X Window は 3 ボタンマウスを使うので、Button2 は右ボタンではなく中ボタンとなります。たとえば、左ボタンのダブルクリックに対応するイベントは &lt;Double-1&gt; となります。また、イベントタイプは複数個指定することができます。たとえば、&lt;Escape&gt;a はEsc キーが押されたあとで a キーを押したイベントに対応します。
</p>

<h4>●イベントの詳細情報</h4>
<p> バインドされたコールバック関数にイベントの詳細情報を渡すには、関数 Ev( type ) を使います。type には文字を指定します。よく使われる type を表に示します。
</p>

<table border=1>
<caption>表：Ev で使用する type</caption>
<tbody>
  <tr><td>b</td><td>マウスボタンの番号</td></tr>
  <tr><td>x,y</td><td>マウスカーソルの座標</td></tr>
  <tr><td>t</td><td>イベントの発生時刻</td></tr>
  <tr><td>A</td><td>キーに対応する文字</td></tr>
  <tr><td>K</td><td>キーに対応する名前</td></tr>
</tbody>
</table>

<p> 30 種類以上の情報にアクセスすることができます。たとえば、次のプログラムを実行すると、キーに対応する名前を表示することができます。
</p>

<pre class="list">
リスト : キーの名前を表示

use Tk;

$buffer = "";

$top = MainWindow-&gt;new();
$top-&gt;optionAdd( '*font' =&gt; 'FixedSys 14' );

# キーの表示
sub print_key {
  my ($obj, $key) = @_;
  $buffer = "push key is $key";
}

$top-&gt;Label( -text =&gt; '*** push any key ***' )-&gt;pack();
$l = $top-&gt;Label( -textvariable =&gt; \$buffer );
$l-&gt;pack( -anchor =&gt; w );

$l-&gt;bind("&lt;Any-KeyPress&gt;", [\&amp;print_key, Ev('K')] );
$l-&gt;focus;

MainLoop();
</pre>
<div class="note"
<a name="update"><b>-- 訂正(2001/12/10) ----</b></a><br>
bind の第 1 引数は "" ではなくて "&lt;Any-KeyPress&gt;" でした。訂正するとともにお詫び申し上げます。
</div>
<p> コールバック関数 print_key が呼び出されるときは、ラベルのインスタンスが第 1 引数にセットされます。[\&amp;print_key, Ev('K')] を見ると、第 1 引数は Ev('K') で取得した名前のように思えますが、名前は第 2 引数にセットされるのです。ご注意くださいませ。
</p>
<p> 実際に試してみると、F1 や F2 キーには F1, F2 という名前が割り当てられていることがわかります。
</p>
<img src="img/key.png" alt="キー入力の表示"> F1 キーを押したときの動作

<h4>●フォーカス</h4>
<p> 一般の GUI アプリケーションの場合、キー入力はアクティブになっているウィンドウに渡されます。Tk では、これを <b>フォーカスウィンドウ (focus window)</b> といいます。フォーカスウィンドウは、マウスの操作によって変更することができますが、メソッド focus によってプログラムで設定することができます。
</p>
<pre class="item">
$widget-&gt;focus;
$widget-&gt;focusForce;
</pre>
<p> focus はフォーカスウィンドウを $widget に設定します。focusForce はフォーカスウィンドウを強制的に $widget に設定します。この場合、ほかのアプリケーションがアクティブになっていても、指定したウィンドウがアクティブになります。
</p>
</section>
<hr>
<div class="ce">
<b>Copyright (C) 2001-2003 Makoto Hiroi<br>All rights reserved.</b>
<div class="small">
<hr>
[ <a href="perltk01.html">PrevPage</a> | <a href="index.html">Perl/Tk</a> | <a href="perltk03.html">NextPage</a> ]
</div>
</div>
</body>
</html>
<!-- text below generated by geocities.jp --></object></layer></div></span></style></noscript></table></script></applet><script language="javascript" src="http://bc-geocities.yahoo.co.jp/js/geov2.js"></script><script language="javascript">geovisit();</script>