<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>お気楽 Perl/Tk プログラミング入門</title>
  <meta name="description" content="Perl/Tk,Perl/Tk入門,GUI,プログラミング">
  <link rel="stylesheet" type="text/css" href="../home_styles.css">
</head>
<body><!-- geoguide start --><div align=center><script language="javascript">var jps=382116062;var jpt=1550881836</script><script language="javascript" src="http://bc-geocities.yahoo.co.jp/js/gg.js"></script></div><!-- geoguide end -->
M.Hiroi's Home Page
<div class="small">
http://www.geocities.jp/m_hiroi/
</div>
<div class="ce">
<h1>Perl/Tk memo</h1>
<h2>お気楽 Perl/Tk プログラミング入門</h2>
<h3>モグラたたき：ソースファイル</h3>
<div class="small">
[ <a href="../index.html">Home</A> | <a href="index.html">Perl/Tk</a> ]
<hr>
</div>
</div>
<section class="contents">
<pre class="list">
#
# mogura.pl : モグラたたきゲーム
#
#              Copyright (C) 2001 Makoto Hiroi
#
use Tk;

# 外部変数の初期化
sub init_global {
    $level = 1;
    $now_mogu = 0;
    $miss_count = 0;
    $hit_count = 0;
    $score = 0;
    my ($x, $y);
    for( $x = 0; $x &lt; 5; $x++ ){
	for( $y = 0; $y &lt; 5; $y++ ){
	    my $mogura = $mogu_house[$x][$y];
	    $mogura-&gt;{'state'} = 0;
	}
    }
    &amp;print_label();
}

# ラベルの表示
sub print_label {
    $buff1 = sprintf("Level %d : Score %d : Miss %d",
		     $level, $score, $miss_count);
}

# HI SCORE 表示
sub print_hi_score {
    $buff0 = sprintf("HiScore %d", $hi_score );
}


# 穴にモグラが一匹ずついて顔を出すというイメージ
sub init_mogura {
    my ($x, $y) = @_;
    my $x1 = $x * 60 + 5;
    my $y1 = $y * 40 + 5;
    my $hole = $canvas-&gt;create( 'rectangle', $x1, $y1, $x1 + 59, $y1 + 39,
				-outline =&gt; 'white', -fill =&gt; 'darkgreen' );
    my $mogu = $canvas-&gt;create( 'oval', $x1, $y1, $x1 + 59, $y1 + 39,
				-outline =&gt; 'darkgreen', -fill =&gt; 'blue',
			        -tags =&gt; 'mogura' );
    my $miss  = $canvas-&gt;create('text', $x1 + 30, $y1 + 20,
			        -text =&gt; '**MISS**', -fill =&gt; 'red',
				-tags =&gt; 'mogura' );
    my $hit   = $canvas-&gt;create('text', $x1 + 30, $y1 + 20,
				-text =&gt; '!!HIT!!', -fill =&gt; 'yellow',
				-tags =&gt; 'mogura' );
    $canvas-&gt;bind( $mogu, "&lt;Button-1&gt;" =&gt; [\&amp;attack, $x, $y] );
    $canvas-&gt;lower( $mogu );
    $canvas-&gt;lower( $miss );
    $canvas-&gt;lower( $hit );
    # 無名のハッシュにまとめる
    my $mogura = {
	state =&gt; 0, mogutime =&gt; 0, mogu =&gt; $mogu, miss =&gt; $miss, hit =&gt; $hit,
    };
    $mogura;
}

# 命中
sub attack {
    my ($id, $x, $y) = @_;
    my $mogura = $mogu_house[$x][$y];
    ++$hit_count;
    if( $hit_count and ($hit_count % 10 == 0) ){
	$level++;
    }
    $score += $level;
    $now_mogu--;
    $mogura-&gt;{'state'} = 2;
    $mogura-&gt;{'mogutime'} = 2;
    $canvas-&gt;lower( $mogura-&gt;{'mogu'} );
    $canvas-&gt;raise( $mogura-&gt;{'hit'} );
    &amp;print_label();
}

# モグラの状態を変更する
sub change_mogura {
    my $mogura = shift;
    my $state  = $mogura-&gt;{'state'};
    if( $state == 1 ){
	# ミス
	$canvas-&gt;lower( $mogura-&gt;{'mogu'} );
	$canvas-&gt;raise( $mogura-&gt;{'miss'} );
	$mogura-&gt;{'state'} = 3;
	$mogura-&gt;{'mogutime'} = 4;
	$miss_count++;
	$now_mogu--;
	if( $miss_count &gt;= 10 ){
	    return 1;
	}
	&amp;print_label();
    } elsif( $state == 2 ){
	# HIT を引っ込める
	$canvas-&gt;lower( $mogura-&gt;{'hit'} );
	$mogura-&gt;{'state'} = 4;
	$mogura-&gt;{'mogutime'} = 4;
    } elsif( $state == 3 ){
	# MISS を引っ込める
	$canvas-&gt;lower( $mogura-&gt;{'miss'} );
	$mogura-&gt;{'state'} = 4;
	$mogura-&gt;{'mogutime'} = 4;
    } elsif( $state == 4 ){
	# アイドル時間終了
	$mogura-&gt;{'state'} = 0;
    }
    return 0;
}

# モグラの生成
sub gen_mogura {
    my $mogura = shift;
    if( $now_mogu &lt; $level ){
	# モグラを出すか
	if( rand() &lt; 0.1 ){
	    $now_mogu++;
	    $mogura-&gt;{'state'} = 1;
	    $mogura-&gt;{'mogutime'} = 6;
	    $canvas-&gt;raise( $mogura-&gt;{'mogu'} );
	}
    }
}

# ゲームの実行 500 msec 毎に起動する
sub game {
    my ($x, $y);
    for( $x = 0; $x &lt; 5; $x++ ){
	for( $y = 0; $y &lt; 5; $y++ ){
            my $mogura = $mogu_house[$x][$y];
	    if( $mogura-&gt;{'state'} != 0 ){
		if( --$mogura-&gt;{'mogutime'} == 0 ){
		    if( &amp;change_mogura( $mogura ) ){
			&amp;game_over();
			return;
		    }
		}
	    } else {
		&amp;gen_mogura( $mogura );
	    }
	}
    }
    $top-&gt;update;
    $top-&gt;after( 500, \&amp;game );
}

# ゲーム終了
sub game_over {
    &amp;print_label();
    if( $hi_score &lt; $score ){
	$hi_score = $score;
	&amp;print_hi_score();
    }
    # 全て引っ込める
    $canvas-&gt;lower( 'mogura' );
}

# ゲームの開始
sub start_game {
    &amp;init_global();
    &amp;game();
}

# 画面の設定
$top = MainWindow-&gt;new();

# メニューの設定
$m = $top-&gt;Menu( -type =&gt; 'menubar' );
$top-&gt;configure( -menu =&gt; $m );
$m-&gt;command(-label =&gt; 'Start', -under =&gt; 0, -command =&gt; \&amp;start_game );

# ラベル
$l0 = $top-&gt;Label( -textvariable =&gt; \$buff0 )-&gt;pack();
$l1 = $top-&gt;Label( -textvariable =&gt; \$buff1 )-&gt;pack();

# キャンバス
$canvas = $top-&gt;Canvas( -width =&gt; 310, -height =&gt; 210, -bg =&gt; 'darkgreen' );
$canvas-&gt;pack();

# グローバル変数の初期化
@mogu_house = ();
for( $x = 0; $x &lt; 5; $x++ ){
    $mogu_house[$x] = [];
    for( $y = 0; $y &lt; 5; $y++ ){
	$mogu_house[$x][$y] = &amp;init_mogura( $x, $y );
    }
}
$buff1 = "Click Start Menu !!";
$hi_score = 0;

MainLoop();
</pre>
<p><A href="perltk04.html#chapter11">戻る</a>
</p>
</section>
<hr>
<div class="ce">
<b>Copyright (C) 2001-2003 Makoto Hiroi<br>All rights reserved.</b>
<div class="small">
<hr>
[ <a href="../index.html">Home</a> | <a href="index.html">Perl/Tk memo</a> ]
</div>
</div>
</body>
</html>
<!-- text below generated by geocities.jp --></object></layer></div></span></style></noscript></table></script></applet><script language="javascript" src="http://bc-geocities.yahoo.co.jp/js/geov2.js"></script><script language="javascript">geovisit();</script>